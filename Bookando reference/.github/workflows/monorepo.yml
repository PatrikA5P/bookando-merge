name: Monorepo CI

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

jobs:
  check-all:
    name: Full Monorepo Check
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for better analysis

      - name: Check repository structure
        run: |
          echo "üìÅ Repository Structure:"
          ls -la

          # Check for required files
          REQUIRED_FILES=(
            "package.json"
            "backend/package.json"
            "backend/prisma/schema.prisma"
            "types.ts"
            "types-api.ts"
          )

          for file in "${REQUIRED_FILES[@]}"; do
            if [ -f "$file" ]; then
              echo "‚úÖ $file exists"
            else
              echo "‚ùå $file missing"
              exit 1
            fi
          done

      - name: Check for large files
        run: |
          LARGE_FILES=$(find . -type f -size +5M -not -path "*/node_modules/*" -not -path "*/.git/*" || true)
          if [ -n "$LARGE_FILES" ]; then
            echo "‚ö†Ô∏è Large files found:"
            echo "$LARGE_FILES"
          else
            echo "‚úÖ No large files found"
          fi

      - name: Count lines of code
        run: |
          echo "üìä Lines of Code:"
          echo "Frontend:"
          find src components modules -name "*.ts" -o -name "*.tsx" | xargs wc -l | tail -1 || echo "N/A"
          echo "Backend:"
          find backend/src -name "*.ts" | xargs wc -l | tail -1 || echo "N/A"

      - name: Check documentation
        run: |
          DOCS=(
            "README.md"
            "IMPLEMENTATION_ROADMAP.md"
            "ARCHITECTURE.md"
            "MULTI_PLATFORM_ARCHITECTURE.md"
            "backend/README.md"
          )

          for doc in "${DOCS[@]}"; do
            if [ -f "$doc" ]; then
              WORD_COUNT=$(wc -w < "$doc")
              echo "‚úÖ $doc ($WORD_COUNT words)"
            else
              echo "‚ö†Ô∏è $doc missing"
            fi
          done

      - name: Git status check
        run: |
          if [ -n "$(git status --porcelain)" ]; then
            echo "‚ö†Ô∏è Uncommitted changes detected"
            git status --short
          else
            echo "‚úÖ Working directory clean"
          fi

  compatibility-check:
    name: Types Compatibility
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20.x

      - name: Check types-api.ts vs Prisma schema
        run: |
          echo "Checking if types-api.ts is in sync with Prisma schema..."

          # Check for common enums
          ENUMS_IN_PRISMA=$(grep "^enum" backend/prisma/schema.prisma | wc -l)
          ENUMS_IN_TYPES=$(grep "^export enum" types-api.ts | wc -l)

          echo "Enums in Prisma: $ENUMS_IN_PRISMA"
          echo "Enums in types-api.ts: $ENUMS_IN_TYPES"

          if [ $ENUMS_IN_PRISMA -ne $ENUMS_IN_TYPES ]; then
            echo "‚ö†Ô∏è Enum count mismatch - types may be out of sync"
          else
            echo "‚úÖ Enum count matches"
          fi

      - name: Check for deprecated types.ts usage
        run: |
          # Count imports of old types.ts in new code
          OLD_IMPORTS=$(grep -r "from.*types'" src/ components/ modules/ --include="*.ts" --include="*.tsx" | wc -l)
          NEW_IMPORTS=$(grep -r "from.*types-api'" src/ components/ modules/ --include="*.ts" --include="*.tsx" | wc -l)

          echo "Old types.ts imports: $OLD_IMPORTS"
          echo "New types-api.ts imports: $NEW_IMPORTS"

          if [ $NEW_IMPORTS -gt 0 ]; then
            echo "‚úÖ New types-api.ts is being used"
          else
            echo "‚ÑπÔ∏è Migration to types-api.ts pending"
          fi

  summary:
    name: Monorepo Summary
    runs-on: ubuntu-latest
    needs: [check-all, compatibility-check]
    if: always()

    steps:
      - name: Generate summary
        run: |
          echo "# üèóÔ∏è Monorepo CI Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Results" >> $GITHUB_STEP_SUMMARY
          echo "- Structure Check: ${{ needs.check-all.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Compatibility Check: ${{ needs.compatibility-check.result }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ needs.check-all.result }}" == "success" ] && [ "${{ needs.compatibility-check.result }}" == "success" ]; then
            echo "‚úÖ All monorepo checks passed" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚ùå Some checks failed" >> $GITHUB_STEP_SUMMARY
          fi
