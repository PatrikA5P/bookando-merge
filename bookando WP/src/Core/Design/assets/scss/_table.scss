@use 'sass:map';
@use 'sass:color';
@use 'variables' as *;
@use 'mixins' as *;

// =========================
// üìã Table
// =========================


/* Kontextklasse einmalig am √§usseren Wrapper der Tabelle setzen */
.bookando-table-context {
  --actions-w: 150px;
  --checkbox-w: 70px;
  --sc-pad-x: 12px; /* Padding am Scroll-Container + Sticky Offsets */
}

.bookando-table {
  width: 100%;
  border-collapse: separate;
  border-spacing: 0;
  font-size: $bookando-font-size-base;
  background: transparent;
  table-layout: fixed; // wichtig f√ºr Sticky/Ellipsis!

  /* ========= Column-Resizer Theme (f√ºr Handle-Bar & Edge-Handle) ========= */
  --colresizer-line-w: 2px;     /* sichtbare Linienbreite */
  --colresizer-hit-w: 18px;     /* Klick-/Hit-Fl√§che */
  --colresizer-color: #{$bookando-border};
  --colresizer-hover: #{$bookando-primary};
  --colresizer-opacity: .5;
  --colresizer-hover-opacity: .95;

  // Standard-Mindestbreite f√ºr alle Spalten (mit Logik konsistent: 100px)
  th,
  td {
    min-width: 100px;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
    padding: $bookando-spacing-md $bookando-spacing-xs;
  }

  thead {
    tr {
      th {
        font-weight: $bookando-font-weight-medium;
        font-size: $bookando-font-size-base;
        color: $bookando-heading-color;
        letter-spacing: 0.01em;
        user-select: none;
        cursor: default;
        position: relative;
        text-align: left;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;

        &.sortable {
          cursor: pointer;
          transition: color 0.2s ease;
          &:hover { color: $bookando-primary; }
        }
        &.sorted.asc {
          color: $bookando-primary;
          .sort-indicator {
            position: absolute;
            right: 1rem;
            top: 50%;
            transform: translateY(-50%) rotate(0deg);
            pointer-events: none;
            color: $bookando-primary;
          }
        }
        &.sorted.desc {
          color: $bookando-danger;
          .sort-indicator {
            color: $bookando-danger;
            transform: translateY(-50%) rotate(180deg);
            pointer-events: none;
          }
        }

        // --- Resizable Support (NICHT f√ºr Checkbox & Actions) ---
        &.resizable:not(.actions-column):not(.checkbox-column) {
            position: relative;
            user-select: none;

            .header-label-text {
              display: flex;
              align-items: center;
              position: relative;
              padding-right: 0;
              justify-content: space-between;
              height: 100%;
            }

            /* ‚úÖ Letzter Daten-TH: Platz f√ºr den Edge-Handle lassen */
            &:has(.resize-edge) .header-label-text {
              padding-right: var(--colresizer-hit-w);
            }

            /* ‚úÖ Fallback ohne :has ‚Äì greift, wenn du in Vue die Klasse setzt */
            &.is-last-data-th .header-label-text {
              padding-right: var(--colresizer-hit-w);
            }

            .resize-handle {
              position: absolute;
              margin-right: calc(-1 * #{$bookando-spacing-md}/4);
              top: 0;
              right: 0;
              width: var(--colresizer-hit-w);
              margin-right: 0; /* optional: verhindert optische Verschiebung */
              height: 100%;
              cursor: col-resize;
              z-index: 20;
              background: transparent;
              display: flex;
              align-items: center;
              justify-content: center;

              &::before {
                content: '';
                display: block;
                height: 65%;
                width: var(--colresizer-line-w);
                background: var(--colresizer-color);
                opacity: var(--colresizer-opacity);
                border-radius: 1px;
                transition: background 0.2s, opacity 0.2s;
              }

              &:hover::before { background: var(--colresizer-hover); opacity: var(--colresizer-hover-opacity); }
              &:focus::before { opacity: var(--colresizer-hover-opacity); }
              &:active::before { background: var(--colresizer-hover); opacity: 1; }
            }

            &.is-resizing {
              .resize-handle::before {
                background: var(--colresizer-hover);
                opacity: 1;
              }
            }
          }


        /* --- Edge-Handle im letzten Datenspalten-TH --- */
        /* TH darf am rechten Rand ‚Äû√ºberstehen‚Äú, damit der Edge-Handle klickbar ist */
        &.resizable { overflow: visible; }

        /* Klick-/Hit-Fl√§che des Edge-Handles */
        &.resizable .resize-edge {
          position: absolute;
          top: 0; right: 0; bottom: 0;
          width: var(--colresizer-hit-w);      /* gleiche Hit-Fl√§che wie Handle-Bar */
          cursor: col-resize;
          background: transparent;
          z-index: 80;                         /* > actions-column */
        }

        /* Sichtbare Linie ‚Äì schon dezent sichtbar (nicht nur im Hover) */
        &.resizable .resize-edge::before {
          content: '';
          position: absolute;
          top: 15%; bottom: 15%;
          /* Linie exakt mittig in der Hit-Fl√§che, vom rechten Rand gerechnet */
          right: calc(var(--colresizer-hit-w) / 2 - var(--colresizer-line-w) / 2);
          left: auto;
          width: var(--colresizer-line-w);
          background: var(--colresizer-color);
          opacity: var(--colresizer-opacity);
          border-radius: 1px;
          transition: background 0.2s, opacity 0.2s;
        }

        /* Hover/Active/Resizing wie bei der Handle-Bar */
        &.resizable .resize-edge:hover::before,
        &.is-resizing .resize-edge::before {
          background: var(--colresizer-hover);
          opacity: var(--colresizer-hover-opacity);
        }

      }
    }
  }

  // Einheitliche Border unter allen Headerzellen (TH & Resize-TH)
  thead tr th,
  thead tr th.resize-handle-th {
    border-bottom: 2px solid $bookando-border;
  }

  // Immer f√ºr alle Header (unabh√§ngig von resizable)
  .bookando-table thead tr th .header-label-text {
    display: flex;
    align-items: center;
    justify-content: space-between;
    width: 100%;
    min-width: 0;
    overflow: hidden;
  }

  .bookando-table thead tr th .header-label-text > span {
    flex: 1 1 0%;
    min-width: 0;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
    display: block;
  }

  /* Sort-Icon (oder letzter Slot-Inhalt) soll nicht schrumpfen,
    der Label-Text (span) bekommt die Ellipsis */
  .bookando-table thead tr th .header-label-text > *:last-child {
    flex: 0 0 auto;
    min-width: auto;
  }

  // Body: Zeilen & Zellen
  tbody {
    tr {
      td, th {
        font-size: inherit;
        color: $bookando-text-dark;
        vertical-align: middle;
        user-select: text;
        caret-color: transparent;
        overflow: hidden;
        text-overflow: ellipsis;
      }

      &.accordion-row {
        position: relative;

        &::after {
          content: "";
          display: block;
          position: absolute;
          left: 0;
          right: 0;
          bottom: 0;
          height: 1px;
          background: $bookando-border-light;
          z-index: 1;
          pointer-events: none;
        }
      }

      &:hover,
      &:focus-within {
        background: $bookando-bg-gray-100;
        td, th { background: $bookando-bg-gray-100; }
      }
    }
  }

  /* Generische Sticky-First/Last deaktivieren ‚Äì nur explizite Klassen verwenden */
  th:first-child,
  td:first-child,
  th:last-child,
  td:last-child {
    position: static;
    left: auto;
    right: auto;
    z-index: auto;
    background: inherit;
  }

  /* Falsche .sticky-col-Klassen global neutralisieren */
  .sticky-col:not(.checkbox-column):not(.actions-column) {
    position: static !important;
    left: auto !important;
    right: auto !important;
    z-index: auto !important;
    background: inherit !important;
  }

  /* Customer soll NICHT sticky sein ‚Äì harte R√ºcknahme, falls irgendwo gesetzt */
  [data-col="customer"] {
    position: static !important;
    left: auto !important;
    right: auto !important;
    z-index: auto !important;
  }

  /* Links: Checkbox-Spalte (STICKY, 50px) */
  th.checkbox-column,
  td.checkbox-column {
    position: sticky;
    left: 0;
    z-index: 30;
    background: $bookando-white;
    padding: $bookando-spacing-md;
    text-align: left;
    user-select: none;
    width: var(--checkbox-w) !important;
    min-width: var(--checkbox-w) !important;
    max-width: var(--checkbox-w) !important;
    transform: translateZ(0);
  }

 /* Rechts: Actions-Spalte (STICKY √ºber root:) */
  th.actions-column,
  td.actions-column {
    position: sticky;
    right: 0;
    z-index: 60;
    background: $bookando-white;
    /* Buttons rechtsb√ºndig */
    text-align: right;
    padding: $bookando-spacing-md;  
    pointer-events: auto;
    resize: none;
    overflow: hidden;
    text-overflow: ellipsis;
    width: var(--actions-w) !important;
    min-width: var(--actions-w) !important;
    max-width: var(--actions-w) !important;
    will-change: transform;
    transform: translateZ(0);
  }

  /* Nur den Header-Text in der Actions-Spalte zentrieren */
  th.actions-column .header-label-text {
    justify-content: center;
    text-align: center;
  }

  /* Gleiche Unterkante bei Accordion-Zeilen f√ºr Checkbox & Actions */
  tbody tr.accordion-row td.checkbox-column::after,
  tbody tr.accordion-row td.actions-column::after {
    content: "";
    position: absolute;
    left: 0; right: 0; bottom: 0;
    height: 1px;
    background: $bookando-border-light;
    pointer-events: none;
    z-index: 61; /* √ºber Zellen-Hintergrund, unter Buttons */
  }

  // Abrundungen Kopf & Fu√ü
  thead tr:first-child th:first-child { border-radius: map.get($bookando-radius-sizes, sm) 0 0 0; }
  thead tr:first-child th:last-child  { border-radius: 0 map.get($bookando-radius-sizes, sm) 0 0; }
  tbody tr:last-child td:first-child  { border-radius: 0 0 0 map.get($bookando-radius-sizes, sm); }
  tbody tr:last-child td:last-child   { border-radius: 0 0 map.get($bookando-radius-sizes, sm) 0; }

  // Responsive
  @include respond-to('md') {
    thead tr th,
    tbody tr td {
      padding: $bookando-spacing-xs $bookando-spacing-sm;
      font-size: $bookando-font-size-sm;
    }
    th.actions-column,
    td.actions-column {
      display: table-cell;
      width: var(--actions-w) !important;
      min-width: var(--actions-w) !important;
      max-width: var(--actions-w) !important;
    }
  }
}

// ==========================
// üìè Resize-Handle TH (Bar)
// ==========================
.bookando-table thead tr th.resize-handle-th {
  width: var(--colresizer-hit-w) !important;
  min-width: var(--colresizer-hit-w) !important;
  max-width: var(--colresizer-hit-w) !important;
  padding: 0 !important;
  background: transparent;
  position: relative;
  cursor: col-resize;
  box-shadow: none;
  z-index: 5;

  .resize-handle {
    position: absolute;
    left: 50%;
    top: 15%;
    bottom: 15%;
    width: var(--colresizer-line-w);
    height: 70%;
    background: var(--colresizer-color);
    opacity: var(--colresizer-opacity);
    border-radius: 1px;
    transform: translateX(-50%);
    transition: background 0.2s, opacity 0.2s;
    z-index: 20;
  }

  &:hover .resize-handle,
  &:active .resize-handle {
    background: var(--colresizer-hover);
    opacity: var(--colresizer-hover-opacity);
  }
}


.bookando-table tbody tr td.resize-handle-th {
  width: var(--colresizer-hit-w) !important;
  min-width: var(--colresizer-hit-w) !important;
  max-width: var(--colresizer-hit-w) !important;
  padding: 0 !important;
  background: transparent !important;
  border: none !important;
  box-shadow: none !important;
  pointer-events: none;
  z-index: 1;
}

// ========================
// üìã Pagination
// ========================
.bookando-pagination {
  display: flex;
  justify-content: center;
  gap: $bookando-spacing-xxs;
  margin-top: $bookando-spacing-md;
  margin-bottom: $bookando-spacing-md;

  .bookando-btn {
    @include bookando-btn-pagination;
  }
}

/* Mobile-Feinschliff: engeres Spacing & Range nicht umbrechen */
@include respond-to('md') {
  .bookando-pagination {
    margin-top: $bookando-spacing-xs;
    margin-bottom: $bookando-spacing-sm;
  }
  .bookando-pagination-range {
    white-space: nowrap;
  }
}

// ========================
// üë§ Avatar, Flags, Accordion
// ========================
.avatar {
  background: $bookando-secondary;
  color: $bookando-text-dark;
  @include flex-center;
  @include rounded-full;
  width: 2em;
  height: 2em;
  font-weight: $bookando-font-weight-bold;
  margin-right: $bookando-spacing-sm;
  font-size: 1em;
}

.flag { @include bookando-flag; }
.flag--sm { font-size: 1em; }
.flag--muted { opacity: 0.5; }

// ============= Accordion & Details =============
.accordion-row { cursor: pointer; user-select: none; }

.accordion-detail-row > td {
  background: $bookando-bg-light;
  border-bottom: 1px solid $bookando-border-light;
  padding: 0;
  user-select: text;
  overflow-x: clip;
  position: relative; // verhindert "Wandern" beim Scrollen
  z-index: 1;
}

.accordion-detail-row > td > .customer-detail-accordion {
  inline-size: 100cqi;
  max-inline-size: 100cqi;
  box-sizing: border-box;
  padding: $bookando-spacing-sm $bookando-spacing-md;
}

@supports not (width: 1cqi) {
  .accordion-detail-row > td > .customer-detail-accordion {
    max-width: 100%;
    inline-size: auto;
  }
}

.bookando-table-detail { display: flex; flex-direction: column; align-items: flex-start; min-width: 0; }

.detail-title {
  font-weight: $bookando-font-weight-bold;
  margin-bottom: map.get($bookando-spacing, sm);
  font-size: $bookando-font-size-base;
  color: var(--bookando-primary, #1976d2);
  letter-spacing: 0.01em;
}

.detail-row { display: flex; align-items: flex-start; gap: map.get($bookando-spacing, sm); padding: map.get($bookando-spacing, xxs) 0; font-size: $bookando-font-size-base; }
.detail-label { min-width: 110px; color: var(--bookando-text-muted, #888); font-weight: $bookando-font-weight-normal; text-align: left; }
.detail-value { color: var(--bookando-text, #222); word-break: break-word; }

// ========================
// ‚öôÔ∏è Aktionen ‚Äì Icon Buttons
// ========================
.bookando-action-icons {
  display: flex;
  gap: $bookando-spacing-xs;

  button.bookando-btn--icon {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    height: $bookando-field-height-sm;
    width: $bookando-field-height-sm;
    background: transparent;
    border: none;
    border-radius: $bookando-radius-circle;
    padding: 0;
    margin: 0 $bookando-spacing-xs;
    transition: background 0.16s, box-shadow 0.18s, transform 0.16s;
    box-shadow: none;
    cursor: pointer;

    &:hover,
    &:focus {
      background: color.scale($bookando-secondary, $lightness: 2%);
      box-shadow: 0 0 0 2px $bookando-accent;
      outline: none;
      transform: scale(1.13);
    }

    &:active { background: $bookando-primary; }
  }
}

// ========================
// ‚ú® Transitions
// ========================
.slide-up-enter-active,
.slide-up-leave-active { transition: all 0.2s; }
.slide-up-enter-from,
.slide-up-leave-to { transform: translateY(100%); opacity: 0; }

.fade-enter-active,
.fade-leave-active { transition: opacity 0.2s; }
.fade-enter-from,
.fade-leave-to { opacity: 0; }

// ========================
// üö´ Kein Caret im Table
// ========================
.bookando-table,
.bookando-table * { caret-color: transparent !important; }

// ========================
// ‚òëÔ∏è Table Checkbox in Cell
// ========================
.checkbox-cell {
  display: flex;
  justify-content: center;
  align-items: center;
  padding: $bookando-spacing-xs;

  input[type="checkbox"] { @include bookando-checkbox(); }
}

// ========================
// Scroll-Container
// ========================
.bookando-table-scroll-container {
  width: 100%;
  min-width: 100px;
  max-width: none;
  position: relative;
  container-type: inline-size;
  overflow-y: auto;
  overflow-x: auto;
  -webkit-overflow-scrolling: touch;
}

// ========================
// üîé Filter (optional)
// ========================
.bookando-table-filter {
  max-width: 320px;
  margin-bottom: $bookando-spacing-md;

  input[type="search"],
  input[type="text"] {
    width: 100%;
    padding: $bookando-spacing-xs $bookando-spacing-sm;
    border: $bookando-border-width-sm solid $bookando-border-light;
    border-radius: $bookando-radius;
    font-size: $bookando-font-size-base;
    transition: border-color 0.2s;

    &:focus {
      border-color: $bookando-primary;
      outline: none;
      box-shadow: 0 0 0 2px rgba($bookando-primary, 0.3);
    }
  }
}

// ========================
// Inline Edit
// ========================
.inline-edit-input {
  font-family: $bookando-font-family;
  font-size: var(--bookando-font-size-base, 1rem);
  padding: map.get($bookando-spacing, xs) map.get($bookando-spacing, md);
  border: $bookando-border-width-md solid var(--bookando-border);
  border-radius: var(--bookando-radius);
  width: 100%;
  box-sizing: border-box;
  transition: border-color 0.2s ease, box-shadow 0.2s ease;
  background-color: var(--bookando-bg);
  color: var(--bookando-text);

  &:focus {
    border-color: var(--bookando-primary);
    box-shadow: 0 0 5px rgba(18, 222, 157, 0.6);
    outline: none;
    background-color: var(--bookando-white);
  }

  &:disabled {
    background-color: var(--bookando-bg-muted);
    color: var(--bookando-text-muted);
    cursor: not-allowed;
  }
}

.inline-edit-toolbar {
  display: flex;
  gap: map.get($bookando-spacing, sm);
  margin-top: map.get($bookando-spacing, xs);
  justify-content: flex-end;
}

.inline-edit-toolbar button {
  min-width: 4.5em;
  padding: map.get($bookando-spacing, xs) map.get($bookando-spacing, md);
  font-size: $bookando-font-size-sm;
  border-radius: var(--bookando-radius);
  cursor: pointer;
  border: none;
  font-weight: $bookando-font-weight-semi-bold;
  transition: background-color 0.2s ease;

  &.save {
    background-color: var(--bookando-success);
    color: var(--bookando-white);

    &:hover:not(:disabled) { background-color: color.adjust($bookando-success, $lightness: -10%); }
    &:disabled { opacity: 0.5; cursor: not-allowed; }
  }

  &.cancel {
    background-color: var(--bookando-danger);
    color: var(--bookando-white);

    &:hover:not(:disabled) { background-color: color.adjust($bookando-danger, $lightness: -10%); }
  }
}
